#!/bin/bash
resp=$(curl --location --request POST 'https://cloud.chaosnative.com/api/query' -H "Authorization: ${TOKEN}" -H 'Content-Type: application/json' --data-raw '{"query":"mutation createChaosWorkFlow($ChaosWorkFlowInput: ChaosWorkFlowInput!) {\n  createChaosWorkFlow(input: $ChaosWorkFlowInput) {\n    workflow_id\n    workflow_name\n    workflow_description\n    isCustomWorkflow\n  }\n}","variables":{"ChaosWorkFlowInput":{"workflow_manifest":"{\n  \"kind\": \"Workflow\",\n  \"apiVersion\": \"argoproj.io/v1alpha1\",\n  \"metadata\": {\n    \"name\": \"'${WORKFLOW_NAME}'\",\n    \"namespace\": \"demo\",\n    \"creationTimestamp\": null,\n    \"labels\": {\n      \"subject\": \"custom-chaos-workflow_demo\",\n      \"workflows.argoproj.io/controller-instanceid\": \"422912cc-50c5-4e19-8394-91893cdbf32f\"\n    }\n  },\n  \"spec\": {\n    \"templates\": [\n      {\n        \"name\": \"custom-chaos\",\n        \"inputs\": {},\n        \"outputs\": {},\n        \"metadata\": {},\n        \"steps\": [\n          [\n            {\n              \"name\": \"install-chaos-experiments\",\n              \"template\": \"install-chaos-experiments\",\n              \"arguments\": {}\n            }\n          ],\n          [\n            {\n              \"name\": \"pod-delete\",\n              \"template\": \"pod-delete\",\n              \"arguments\": {}\n            }\n          ],\n          [\n            {\n              \"name\": \"revert-chaos\",\n              \"template\": \"revert-chaos\",\n              \"arguments\": {}\n            }\n          ]\n        ]\n      },\n      {\n        \"name\": \"install-chaos-experiments\",\n        \"inputs\": {\n          \"artifacts\": [\n            {\n              \"name\": \"pod-delete\",\n              \"path\": \"/tmp/pod-delete.yaml\",\n              \"raw\": {\n                \"data\": \"apiVersion: litmuschaos.io/v1alpha1\\ndescription:\\n  message: |\\n    Deletes a pod belonging to a deployment/statefulset/daemonset\\nkind: ChaosExperiment\\nmetadata:\\n  name: pod-delete\\n  labels:\\n    name: pod-delete\\n    app.kubernetes.io/part-of: litmus\\n    app.kubernetes.io/component: chaosexperiment\\n    app.kubernetes.io/version: 2.7.0\\nspec:\\n  definition:\\n    scope: Namespaced\\n    permissions:\\n      - apiGroups:\\n          - \\\"\\\"\\n        resources:\\n          - pods\\n        verbs:\\n          - create\\n          - delete\\n          - get\\n          - list\\n          - patch\\n          - update\\n          - deletecollection\\n      - apiGroups:\\n          - \\\"\\\"\\n        resources:\\n          - events\\n        verbs:\\n          - create\\n          - get\\n          - list\\n          - patch\\n          - update\\n      - apiGroups:\\n          - \\\"\\\"\\n        resources:\\n          - configmaps\\n        verbs:\\n          - get\\n          - list\\n      - apiGroups:\\n          - \\\"\\\"\\n        resources:\\n          - pods/log\\n        verbs:\\n          - get\\n          - list\\n          - watch\\n      - apiGroups:\\n          - \\\"\\\"\\n        resources:\\n          - pods/exec\\n        verbs:\\n          - get\\n          - list\\n          - create\\n      - apiGroups:\\n          - apps\\n        resources:\\n          - deployments\\n          - statefulsets\\n          - replicasets\\n          - daemonsets\\n        verbs:\\n          - list\\n          - get\\n      - apiGroups:\\n          - apps.openshift.io\\n        resources:\\n          - deploymentconfigs\\n        verbs:\\n          - list\\n          - get\\n      - apiGroups:\\n          - \\\"\\\"\\n        resources:\\n          - replicationcontrollers\\n        verbs:\\n          - get\\n          - list\\n      - apiGroups:\\n          - argoproj.io\\n        resources:\\n          - rollouts\\n        verbs:\\n          - list\\n          - get\\n      - apiGroups:\\n          - batch\\n        resources:\\n          - jobs\\n        verbs:\\n          - create\\n          - list\\n          - get\\n          - delete\\n          - deletecollection\\n      - apiGroups:\\n          - litmuschaos.io\\n        resources:\\n          - chaosengines\\n          - chaosexperiments\\n          - chaosresults\\n        verbs:\\n          - create\\n          - list\\n          - get\\n          - patch\\n          - update\\n          - delete\\n    image: litmuschaos/go-runner:2.7.0\\n    imagePullPolicy: Always\\n    args:\\n      - -c\\n      - ./experiments -name pod-delete\\n    command:\\n      - /bin/bash\\n    env:\\n      - name: TOTAL_CHAOS_DURATION\\n        value: \\\"15\\\"\\n      - name: RAMP_TIME\\n        value: \\\"\\\"\\n      - name: FORCE\\n        value: \\\"true\\\"\\n      - name: CHAOS_INTERVAL\\n        value: \\\"5\\\"\\n      - name: PODS_AFFECTED_PERC\\n        value: \\\"\\\"\\n      - name: LIB\\n        value: litmus\\n      - name: TARGET_PODS\\n        value: \\\"\\\"\\n      - name: SEQUENCE\\n        value: parallel\\n    labels:\\n      name: pod-delete\\n      app.kubernetes.io/part-of: litmus\\n      app.kubernetes.io/component: experiment-job\\n      app.kubernetes.io/version: 2.7.0\\n\"\n              }\n            }\n          ]\n        },\n        \"outputs\": {},\n        \"metadata\": {},\n        \"container\": {\n          \"name\": \"\",\n          \"image\": \"litmuschaos/k8s:latest\",\n          \"command\": [\n            \"sh\",\n            \"-c\"\n          ],\n          \"args\": [\n            \"kubectl apply -f /tmp/pod-delete.yaml -n {{workflow.parameters.adminModeNamespace}} |  sleep 30\"\n          ],\n          \"resources\": {}\n        }\n      },\n      {\n        \"name\": \"pod-delete\",\n        \"inputs\": {\n          \"artifacts\": [\n            {\n              \"name\": \"pod-delete\",\n              \"path\": \"/tmp/chaosengine-pod-delete.yaml\",\n              \"raw\": {\n                \"data\": \"apiVersion: litmuschaos.io/v1alpha1\\nkind: ChaosEngine\\nmetadata:\\n  namespace: \\\"{{workflow.parameters.adminModeNamespace}}\\\"\\n  generateName: pod-delete\\n  labels:\\n    instance_id: 376c2897-3fe7-4b0c-b8c2-bf78e1ed6b0e\\n    context: pod-delete_demo\\n    workflow_name: custom-chaos-workflow-1653217135\\nspec:\\n  appinfo:\\n    appns: demo\\n    applabel: app=nginx\\n    appkind: deployment\\n  engineState: active\\n  chaosServiceAccount: litmus-admin\\n  experiments:\\n    - name: pod-delete\\n      spec:\\n        components:\\n          env:\\n            - name: TOTAL_CHAOS_DURATION\\n              value: \\\"30\\\"\\n            - name: CHAOS_INTERVAL\\n              value: \\\"10\\\"\\n            - name: FORCE\\n              value: \\\"false\\\"\\n            - name: PODS_AFFECTED_PERC\\n              value: \\\"\\\"\\n        probe: []\\n  annotationCheck: \\\"false\\\"\\n\"\n              }\n            }\n          ]\n        },\n        \"outputs\": {},\n        \"metadata\": {\n          \"labels\": {\n            \"weight\": \"10\"\n          }\n        },\n        \"container\": {\n          \"name\": \"\",\n          \"image\": \"litmuschaos/litmus-checker:latest\",\n          \"args\": [\n            \"-file=/tmp/chaosengine-pod-delete.yaml\",\n            \"-saveName=/tmp/engine-name\"\n          ],\n          \"resources\": {}\n        }\n      },\n      {\n        \"name\": \"revert-chaos\",\n        \"inputs\": {},\n        \"outputs\": {},\n        \"metadata\": {},\n        \"container\": {\n          \"name\": \"\",\n          \"image\": \"litmuschaos/k8s:latest\",\n          \"command\": [\n            \"sh\",\n            \"-c\"\n          ],\n          \"args\": [\n            \"kubectl delete chaosengine -l '\''instance_id in (376c2897-3fe7-4b0c-b8c2-bf78e1ed6b0e, )'\'' -n {{workflow.parameters.adminModeNamespace}} \"\n          ],\n          \"resources\": {}\n        }\n      }\n    ],\n    \"entrypoint\": \"custom-chaos\",\n    \"arguments\": {\n      \"parameters\": [\n        {\n          \"name\": \"adminModeNamespace\",\n          \"value\": \"demo\"\n        }\n      ]\n    },\n    \"serviceAccountName\": \"argo-chaos\",\n    \"podGC\": {\n      \"strategy\": \"OnWorkflowCompletion\"\n    },\n    \"securityContext\": {\n      \"runAsUser\": 1000,\n      \"runAsNonRoot\": true\n    }\n  },\n  \"status\": {\n    \"startedAt\": null,\n    \"finishedAt\": null\n  }\n}","workflow_name":"'${WORKFLOW_NAME}'","project_id":"'${PROJECT_ID}'","cluster_id":"'${CLUSTER_ID}'","workflow_description": "Pod delete-experiment","isCustomWorkflow": true,"weightages":[{"experiment_name":"pod-delete","weightage":10}],"cronSyntax":""}}}')
echo $resp     
          
